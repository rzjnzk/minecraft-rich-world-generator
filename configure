#!/bin/sh

(

_main()
{
    cd "${_script_path}"

    git config commit.template .gitmessage

    mkdir -p \
        ./build/libs \
        ./build/classes \
        ./build/spigot-buildtools \
        ./bin

    test -f ./build/libs/spigot-api-1.15.2-R0.1-20200208.235302-49.jar ||
        curl https://hub.spigotmc.org/nexus/content/repositories/snapshots/org/spigotmc/spigot-api/1.15.2-R0.1-SNAPSHOT/spigot-api-1.15.2-R0.1-20200208.235302-49.jar \
        -o ./build/libs/spigot-api-1.15.2-R0.1-20200208.235302-49.jar &&
        printf -- "Spigot API jar installed.\n"

    test -f ./build/spigot-buildtools/BuildTools.jar ||
        curl https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar \
        -o ./build/spigot-buildtools/BuildTools.jar &&
        printf -- "Spigot \`BuildTools.jar\` installed.\n"

    if
        test -f ./bin/spigot*.jar
    then
        printf -- "Not commpiling spigot, spigot jar found.\n"
    else
        cd ./build/spigot-buildtools
        java -jar ./BuildTools.jar --compile SPIGOT -o ../../bin
        cd ../../
    fi

    cp -fv "./configure.d/bukkit.yml" "./bin"
    cp -fv "./configure.d/eula.txt" "./bin"
    cp -fv "./configure.d/ops.json" "./bin"
}

set -e
_script_name="$(basename "${0}")"
_script_path="$(dirname "${0}")"
_script_path="$(cd "${_script_path}" ; pwd)"
_script_args="$(printf -- "%s\n" "${@}")"
mkdir -p "${_script_path}/${_script_name}-logs"
_main "${@}" | tee --append -- "${_script_path}/${_script_name}-logs/$(date --utc +%Y-%m-%d_%H-%M-%S)_utc.log"

)
